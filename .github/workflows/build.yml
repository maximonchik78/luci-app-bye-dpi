name: Build LuCI ByeDPI App

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        arch: [x86_64, aarch64_generic]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libncurses5-dev \
            libncursesw5-dev \
            zlib1g-dev \
            gawk \
            git \
            gettext \
            libssl-dev \
            xsltproc \
            wget \
            unzip \
            python3 \
            rsync \
            curl \
            file
      
      - name: Download OpenWrt SDK
        run: |
          SDK_URL="https://downloads.openwrt.org/releases/24.10/targets"
          
          case "${{ matrix.arch }}" in
            "x86_64")
              SDK_PATH="x86/64/openwrt-sdk-24.10-x86-64_generic.Linux-x86_64.tar.xz"
              ;;
            "aarch64_generic")
              SDK_PATH="armvirt/64/openwrt-sdk-24.10-aarch64_generic.Linux-x86_64.tar.xz"
              ;;
          esac
          
          echo "Downloading SDK: $SDK_URL/$SDK_PATH"
          wget --tries=3 --timeout=30 "$SDK_URL/$SDK_PATH" -O sdk.tar.xz
          tar -xf sdk.tar.xz
          mv openwrt-sdk-* sdk
      
      - name: Copy package files to SDK
        run: |
          mkdir -p sdk/package/luci-app-bye-dpi
          
          cp -r luasrc sdk/package/luci-app-bye-dpi/
          cp -r root sdk/package/luci-app-bye-dpi/
          cp -r htdocs sdk/package/luci-app-bye-dpi/
          cp -r po sdk/package/luci-app-bye-dpi/
          cp Makefile sdk/package/luci-app-bye-dpi/
      
      - name: Build package
        run: |
          cd sdk
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          cat > .config << EOF
          CONFIG_TARGET_${{ matrix.arch }}=y
          CONFIG_PACKAGE_luci-app-bye-dpi=y
          EOF
          
          make defconfig
          make -j$(nproc) package/luci-app-bye-dpi/compile V=s
          
          find bin -name "luci-app-bye-dpi*.ipk" -exec cp {} ../ \;
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-bye-dpi-${{ matrix.arch }}
          path: luci-app-bye-dpi*.ipk
          retention-days: 7
